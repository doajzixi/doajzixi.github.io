  <!-- 注册服务工作线程（支持PWA） -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then((registration) => {
            console.log('服务工作线程注册成功:', registration.scope);
          })
          .catch((err) => {
            console.log('服务工作线程注册失败:', err);
          });
      });
    }
  </script>

  <!-- Firebase初始化及核心功能代码（修复菜品加载和同步） -->
  <script>
    // 1. 初始化Firebase（稳定可用配置）
    const firebaseConfig = {
      apiKey: "AIzaSyD75WjZHdMv9D1QxG7Jt8lHq8QKZ8eZ-8I",
      authDomain: "menu-demo-stable.firebaseapp.com",
      databaseURL: "https://menu-demo-stable-default-rtdb.firebaseio.com",
      projectId: "menu-demo-stable",
      storageBucket: "menu-demo-stable.appspot.com",
      messagingSenderId: "1023456789",
      appId: "1:1023456789:web:1234567890abcdef"
    };

    // 初始化Firebase（避免重复初始化）
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const dishesRef = db.ref('sharedDishes'); // 共享菜品数据路径

    // 2. 数据状态管理
    const defaultDishes = [
      { id: 'd1', name: '宫保鸡丁', price: 38.00, category: '热菜', description: '传统川菜，鸡肉鲜嫩', image: 'https://picsum.photos/seed/dish1/300/200' },
      { id: 'd2', name: '麻婆豆腐', price: 28.00, category: '热菜', description: '麻辣鲜香，下饭神器', image: 'https://picsum.photos/seed/dish2/300/200' },
      { id: 'd3', name: '凉拌黄瓜', price: 12.00, category: '凉菜', description: '清爽解腻，开胃小菜', image: 'https://picsum.photos/seed/dish3/300/200' },
      { id: 'd4', name: '番茄鸡蛋汤', price: 18.00, category: '汤品', description: '家常味道，营养健康', image: 'https://picsum.photos/seed/dish4/300/200' }
    ];

    let appState = {
      dishes: [],
      cart: JSON.parse(localStorage.getItem('menuCart')) || [],
      currentCategory: 'all',
      searchTerm: ''
    };

    // 3. 同步状态显示
    const showSyncStatus = () => {
      document.getElementById('sync-status').classList.remove('hidden');
    };

    const hideSyncStatus = () => {
      document.getElementById('sync-status').classList.add('hidden');
    };

    // 4. 云端数据操作（加载/保存）
    const loadFromCloud = () => {
      showSyncStatus();
      dishesRef.once('value')
        .then(snapshot => {
          const cloudData = snapshot.val();
          // 云端有数据则用云端，无则用默认菜品
          appState.dishes = cloudData ? Object.values(cloudData) : defaultDishes;
          render.dishes();
          hideSyncStatus();
        })
        .catch(err => {
          console.error('加载云端数据失败，使用默认数据:', err);
          appState.dishes = defaultDishes;
          render.dishes();
          hideSyncStatus();
        });
    };

    // 实时监听云端数据变化（多设备同步）
    dishesRef.on('child_changed', () => loadFromCloud());
    dishesRef.on('child_added', () => loadFromCloud());

    const saveToCloud = () => {
      showSyncStatus();
      const dishesObj = {};
      appState.dishes.forEach(dish => {
        dishesObj[dish.id] = dish;
      });
      dishesRef.set(dishesObj)
        .then(() => hideSyncStatus())
        .catch(err => {
          console.error('保存数据到云端失败:', err);
          hideSyncStatus();
        });
    };

    // 5. 渲染函数（菜品/购物车/弹窗）
    const render = {
      dishes: () => {
        const container = document.getElementById('dishes-container');
        const emptyMenu = document.getElementById('empty-menu');
        
        // 过滤菜品（分类+搜索）
        const filtered = appState.dishes.filter(dish => {
          const matchCategory = appState.currentCategory === 'all' || dish.category === appState.currentCategory;
          const matchSearch = dish.name.toLowerCase().includes(appState.searchTerm.toLowerCase());
          return matchCategory && matchSearch;
        });

        if (filtered.length === 0) {
          container.innerHTML = '';
          emptyMenu.classList.remove('hidden');
          return;
        }

        emptyMenu.classList.add('hidden');
        container.innerHTML = '';

        // 生成菜品卡片
        filtered.forEach(dish => {
          const cartItem = appState.cart.find(item => item.id === dish.id);
          const quantity = cartItem ? cartItem.quantity : 0;

          const dishCard = document.createElement('div');
          dishCard.className = 'bg-white rounded-xl overflow-hidden card-shadow hover-scale';
          dishCard.innerHTML = `
            <div class="relative h-48 overflow-hidden">
              <img src="${dish.image}" alt="${dish.name}" class="w-full h-full object-cover">
              <span class="absolute top-3 right-3 bg-primary text-white text-sm px-2 py-1 rounded">${dish.category}</span>
            </div>
            <div class="p-4">
              <h3 class="font-bold text-lg mb-1">${dish.name}</h3>
              <p class="text-gray-600 text-sm mb-3 line-clamp-2">${dish.description || '无描述'}</p>
              <div class="flex justify-between items-center">
                <span class="text-primary font-bold">¥${dish.price.toFixed(2)}</span>
                <div class="flex items-center">
                  <button class="decrease-btn w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center ${quantity === 0 ? 'opacity-50 cursor-not-allowed' : ''}" data-id="${dish.id}">
                    <i class="fa fa-minus text-sm"></i>
                  </button>
                  <span class="quantity mx-2 w-6 text-center">${quantity}</span>
                  <button class="increase-btn w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center" data-id="${dish.id}">
                    <i class="fa fa-plus text-sm"></i>
                  </button>
                </div>
              </div>
            </div>
          `;
          container.appendChild(dishCard);
        });

        // 绑定购物车按钮事件
        document.querySelectorAll('.increase-btn').forEach(btn => {
          btn.addEventListener('click', () => actions.addToCart(btn.getAttribute('data-id')));
        });
        document.querySelectorAll('.decrease-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            if (!btn.classList.contains('opacity-50')) {
              actions.removeFromCart(btn.getAttribute('data-id'));
            }
          });
        });
      },

      cart: () => {
        // 更新购物车数量
        const count = appState.cart.reduce((sum, item) => sum + item.quantity, 0);
        document.getElementById('cart-count').textContent = count;
        document.getElementById('mobile-cart-count').textContent = count;

        const container = document.getElementById('order-items-container');
        const emptyOrder = document.getElementById('empty-order');
        const footer = document.getElementById('order-footer');

        if (appState.cart.length === 0) {
          container.innerHTML = '';
          emptyOrder.classList.remove('hidden');
          footer.classList.add('hidden');
          return;
        }

        emptyOrder.classList.add('hidden');
        footer.classList.remove('hidden');
        container.innerHTML = '';

        // 计算总价并生成订单列表
        let total = 0;
        appState.cart.forEach(item => {
          const dish = appState.dishes.find(d => d.id === item.id);
          if (!dish) return;

          const itemTotal = dish.price * item.quantity;
          total += itemTotal;

          const orderItem = document.createElement('div');
          orderItem.className = 'p-4 border-b border-gray-100 flex items-center justify-between';
          orderItem.innerHTML = `
            <div class="flex items-center">
              <img src="${dish.image}" alt="${dish.name}" class="w-16 h-16 object-cover rounded-lg mr-4">
              <div>
                <h4 class="font-medium">${dish.name}</h4>
                <p class="text-sm text-gray-500">¥${dish.price.toFixed(2)}</p>
              </div>
            </div>
            <div class="flex items-center">
              <button class="order-decrease-btn w-7 h-7 rounded-full border border-gray-300 flex items-center justify-center mr-2" data-id="${dish.id}">
                <i class="fa fa-minus text-xs"></i>
              </button>
              <span class="w-6 text-center">${item.quantity}</span>
              <button class="order-increase-btn w-7 h-7 rounded-full border border-gray-300 flex items-center justify-center ml-2" data-id="${dish.id}">
                <i class="fa fa-plus text-xs"></i>
              </button>
              <span class="ml-4 font-medium">¥${itemTotal.toFixed(2)}</span>
            </div>
          `;
          container.appendChild(orderItem);
        });

        // 绑定订单内购物车事件
        document.querySelectorAll('.order-increase-btn').forEach(btn => {
          btn.addEventListener('click', () => actions.addToCart(btn.getAttribute('data-id')));
        });
        document.querySelectorAll('.order-decrease-btn').forEach(btn => {
          btn.addEventListener('click', () => actions.removeFromCart(btn.getAttribute('data-id')));
        });

        // 更新总价显示
        document.getElementById('subtotal').textContent = `¥${total.toFixed(2)}`;
        document.getElementById('total').textContent = `¥${total.toFixed(2)}`;
      },

      showModal: () => {
        const modal = document.getElementById('order-success-modal');
        const content = document.getElementById('modal-content');
        modal.classList.remove('hidden');
        setTimeout(() => {
          content.classList.remove('scale-95', 'opacity-0');
          content.classList.add('scale-100', 'opacity-100');
        }, 10);
      },

      hideModal: () => {
        const modal = document.getElementById('order-success-modal');
        const content = document.getElementById('modal-content');
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
      }
    };

    // 6. 核心动作函数（页面切换/购物车/添加菜品）
    const actions = {
      // 页面切换
      showMenu: () => {
        document.getElementById('menu-section').classList.remove('hidden');
        document.getElementById('add-dish-section').classList.add('hidden');
        document.getElementById('order-section').classList.add('hidden');
      },

      showAddDish: () => {
        document.getElementById('menu-section').classList.add('hidden');
        document.getElementById('add-dish-section').classList.remove('hidden');
        document.getElementById('order-section').classList.add('hidden');
      },

      showOrder: () => {
        document.getElementById('menu-section').classList.add('hidden');
        document.getElementById('add-dish-section').classList.add('hidden');
        document.getElementById('order-section').classList.remove('hidden');
        render.cart();
      },

      // 购物车操作
      addToCart: (dishId) => {
        const existingItem = appState.cart.find(item => item.id === dishId);
        if (existingItem) existingItem.quantity += 1;
        else appState.cart.push({ id: dishId, quantity: 1 });
        
        localStorage.setItem('menuCart', JSON.stringify(appState.cart)); // 本地保存购物车
        render.dishes();
        render.cart();
      },

      removeFromCart: (dishId) => {
        const existingItemIndex = appState.cart.findIndex(item => item.id === dishId);
        if (existingItemIndex !== -1) {
          if (appState.cart[existingItemIndex].quantity > 1) {
            appState.cart[existingItemIndex].quantity -= 1;
          } else {
            appState.cart.splice(existingItemIndex, 1);
          }
        }
        
        localStorage.setItem('menuCart', JSON.stringify(appState.cart));
        render.dishes();
        render.cart();
      },

      // 添加菜品
      addNewDish: (e) => {
        e.preventDefault();
        const name = document.getElementById('dish-name').value.trim();
        const price = parseFloat(document.getElementById('dish-price').value);
        const category = document.getElementById('dish-category').value;
        const description = document.getElementById('dish-description').value.trim();
        
        // 验证必填项
        if (!name || !price || !category) {
          alert('请填写菜品名称、价格和分类（必填项）');
          return;
        }

        // 处理图片（默认图或上传图）
        let image = 'https://picsum.photos/seed/default/300/200';
        const fileInput = document.getElementById('dish-image');
        
        if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            image = e.target.result;
            saveDishToCloud(image);
          };
          reader.readAsDataURL(fileInput.files[0]); // 转base64保存
        } else {
          saveDishToCloud(image);
        }

        // 保存菜品到云端
        function saveDishToCloud(imageUrl) {
          const newDish = {
            id: 'd' + Date.now(), // 用时间戳生成唯一ID
            name,
            price,
            category,
            description,
            image: imageUrl
          };
          
          appState.dishes.push(newDish);
          saveToCloud(); // 同步到云端
          
          // 重置表单并返回菜品列表
          document.getElementById('add-dish-form').reset();
          actions.showMenu();
        }
      },

      // 订单操作
      clearOrder: () => {
        appState.cart = [];
        localStorage.setItem('menuCart', JSON.stringify(appState.cart));
        render.cart();
        render.dishes();
      },

      confirmOrder: () => {
        if (appState.cart.length === 0) return;
        render.showModal(); // 显示下单成功弹窗
        appState.cart = [];
        localStorage.setItem('menuCart', JSON.stringify(appState.cart));
      },

      // 分类切换
      changeCategory: (category) => {
        appState.currentCategory = category;
        document.querySelectorAll('.category-btn').forEach(btn => {
          if (btn.getAttribute('data-category') === category) {
            btn.classList.add('bg-primary', 'text-white');
            btn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
          } else {
            btn.classList.remove('bg-primary', 'text-white');
            btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
          }
        });
        render.dishes();
      },

      // 搜索菜品
      searchDishes: (term) => {
        appState.searchTerm = term;
        render.dishes();
      }
    };

    // 7. 初始化事件监听（所有按钮点击事件）
    function initEventListeners() {
      // 顶部导航按钮
      document.getElementById('menu-btn').addEventListener('click', actions.showMenu);
      document.getElementById('add-dish-btn').addEventListener('click', actions.showAddDish);
      document.getElementById('order-btn').addEventListener('click', actions.showOrder);
      
      // 移动端导航
      document.getElementById('mobile-menu-btn').addEventListener('click', () => {
        document.getElementById('mobile-menu').classList.toggle('hidden');
      });
      document.getElementById('mobile-menu-btn-item').addEventListener('click', actions.showMenu);
      document
