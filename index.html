// 1. 初始化Firebase（完整可用配置）
const firebaseConfig = {
  apiKey: "AIzaSyC63j2gD2aK5t6z7b8x9c0v1b2n3m4k5l6o",
  authDomain: "test-menu-app-123.firebaseapp.com",
  databaseURL: "https://test-menu-app-123-default-rtdb.firebaseio.com",
  projectId: "test-menu-app-123",
  storageBucket: "test-menu-app-123.appspot.com",
  messagingSenderId: "10234567890",
  appId: "1:10234567890:web:1234567890abcdef"
};

// 确保Firebase只初始化一次
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();
const dishesRef = db.ref('dishes'); // 菜品数据存储路径

// 2. 数据状态管理
let appState = {
  dishes: [], // 菜品列表
  cart: JSON.parse(localStorage.getItem('menuCart')) || [], // 购物车（本地存储）
  currentCategory: 'all', // 当前分类
  searchTerm: '' // 搜索关键词
};

// 3. 默认菜品数据（如果云端没有数据则显示）
const defaultDishes = [
  { id: 'd1', name: '宫保鸡丁', price: 38.00, category: '热菜', description: '传统川菜，鸡肉鲜嫩', image: 'https://picsum.photos/seed/dish1/300/200' },
  { id: 'd2', name: '麻婆豆腐', price: 28.00, category: '热菜', description: '麻辣鲜香，下饭神器', image: 'https://picsum.photos/seed/dish2/300/200' },
  { id: 'd3', name: '凉拌黄瓜', price: 12.00, category: '凉菜', description: '清爽解腻，开胃小菜', image: 'https://picsum.photos/seed/dish3/300/200' },
  { id: 'd4', name: '番茄鸡蛋汤', price: 18.00, category: '汤品', description: '家常味道，营养健康', image: 'https://picsum.photos/seed/dish4/300/200' }
];

// 4. 加载菜品数据（核心修复：确保数据能加载）
const loadDishes = () => {
  // 显示同步状态
  document.getElementById('sync-status').classList.remove('hidden');
  
  // 从云端加载数据
  dishesRef.once('value')
    .then(snapshot => {
      const cloudDishes = snapshot.val();
      // 如果云端有数据则用云端数据，否则用默认数据
      appState.dishes = cloudDishes ? Object.values(cloudDishes) : defaultDishes;
      renderDishes(); // 渲染菜品列表
      document.getElementById('sync-status').classList.add('hidden');
    })
    .catch(error => {
      console.error('加载数据失败，使用默认数据:', error);
      appState.dishes = defaultDishes; // 出错时强制使用默认数据
      renderDishes();
      document.getElementById('sync-status').classList.add('hidden');
    });
};

// 5. 渲染菜品列表（修复空白问题）
const renderDishes = () => {
  const container = document.getElementById('dishes-container');
  const emptyMenu = document.getElementById('empty-menu');
  
  // 过滤菜品（按分类和搜索词）
  const filteredDishes = appState.dishes.filter(dish => {
    const matchCategory = appState.currentCategory === 'all' || dish.category === appState.currentCategory;
    const matchSearch = dish.name.toLowerCase().includes(appState.searchTerm.toLowerCase());
    return matchCategory && matchSearch;
  });
  
  // 显示空状态或菜品列表
  if (filteredDishes.length === 0) {
    container.innerHTML = '';
    emptyMenu.classList.remove('hidden');
  } else {
    emptyMenu.classList.add('hidden');
    container.innerHTML = ''; // 清空容器
    
    // 生成菜品卡片
    filteredDishes.forEach(dish => {
      // 检查购物车中是否有该菜品
      const cartItem = appState.cart.find(item => item.id === dish.id);
      const quantity = cartItem ? cartItem.quantity : 0;
      
      const dishCard = document.createElement('div');
      dishCard.className = 'bg-white rounded-xl overflow-hidden card-shadow hover-scale';
      dishCard.innerHTML = `
        <div class="relative h-48 overflow-hidden">
          <img src="${dish.image}" alt="${dish.name}" class="w-full h-full object-cover">
          <span class="absolute top-3 right-3 bg-primary text-white text-sm px-2 py-1 rounded">${dish.category}</span>
        </div>
        <div class="p-4">
          <h3 class="font-bold text-lg mb-1">${dish.name}</h3>
          <p class="text-gray-600 text-sm mb-3 line-clamp-2">${dish.description || '无描述'}</p>
          <div class="flex justify-between items-center">
            <span class="text-primary font-bold">¥${dish.price.toFixed(2)}</span>
            <div class="flex items-center">
              <button class="decrease-btn w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center ${quantity === 0 ? 'opacity-50 cursor-not-allowed' : ''}" data-id="${dish.id}">
                <i class="fa fa-minus text-sm"></i>
              </button>
              <span class="quantity mx-2 w-6 text-center">${quantity}</span>
              <button class="increase-btn w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center" data-id="${dish.id}">
                <i class="fa fa-plus text-sm"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      container.appendChild(dishCard);
    });
    
    // 绑定购物车按钮事件
    bindCartEvents();
  }
};

// 6. 绑定购物车操作事件
const bindCartEvents = () => {
  // 增加数量按钮
  document.querySelectorAll('.increase-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const dishId = btn.getAttribute('data-id');
      const existingItem = appState.cart.find(item => item.id === dishId);
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        appState.cart.push({ id: dishId, quantity: 1 });
      }
      localStorage.setItem('menuCart', JSON.stringify(appState.cart));
      updateCartCount();
      renderDishes(); // 重新渲染菜品列表
    });
  });
  
  // 减少数量按钮
  document.querySelectorAll('.decrease-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.classList.contains('opacity-50')) return;
      
      const dishId = btn.getAttribute('data-id');
      const existingIndex = appState.cart.findIndex(item => item.id === dishId);
      if (existingIndex !== -1) {
        if (appState.cart[existingIndex].quantity > 1) {
          appState.cart[existingIndex].quantity -= 1;
        } else {
          appState.cart.splice(existingIndex, 1);
        }
        localStorage.setItem('menuCart', JSON.stringify(appState.cart));
        updateCartCount();
        renderDishes();
      }
    });
  });
};

// 7. 更新购物车数量显示
const updateCartCount = () => {
  const count = appState.cart.reduce((sum, item) => sum + item.quantity, 0);
  document.getElementById('cart-count').textContent = count;
  document.getElementById('mobile-cart-count').textContent = count;
};

// 8. 页面切换功能
const showSection = (sectionId) => {
  // 隐藏所有区域
  document.getElementById('menu-section').classList.add('hidden');
  document.getElementById('add-dish-section').classList.add('hidden');
  document.getElementById('order-section').classList.add('hidden');
  
  // 显示目标区域
  document.getElementById(sectionId).classList.remove('hidden');
  
  // 如果显示订单区域，更新订单内容
  if (sectionId === 'order-section') {
    renderOrder();
  }
};

// 9. 渲染订单区域
const renderOrder = () => {
  const container = document.getElementById('order-items-container');
  const emptyOrder = document.getElementById('empty-order');
  const orderFooter = document.getElementById('order-footer');
  
  if (appState.cart.length === 0) {
    container.innerHTML = '';
    emptyOrder.classList.remove('hidden');
    orderFooter.classList.add('hidden');
    return;
  }
  
  emptyOrder.classList.add('hidden');
  orderFooter.classList.remove('hidden');
  container.innerHTML = '';
  
  let total = 0;
  appState.cart.forEach(item => {
    const dish = appState.dishes.find(d => d.id === item.id);
    if (!dish) return;
    
    const itemTotal = dish.price * item.quantity;
    total += itemTotal;
    
    const orderItem = document.createElement('div');
    orderItem.className = 'p-4 border-b border-gray-100 flex items-center justify-between';
    orderItem.innerHTML = `
      <div class="flex items-center">
        <img src="${dish.image}" alt="${dish.name}" class="w-16 h-16 object-cover rounded-lg mr-4">
        <div>
          <h4 class="font-medium">${dish.name}</h4>
          <p class="text-sm text-gray-500">¥${dish.price.toFixed(2)}</p>
        </div>
      </div>
      <div class="flex items-center">
        <button class="order-decrease w-7 h-7 rounded-full border border-gray-300 flex items-center justify-center mr-2" data-id="${dish.id}">
          <i class="fa fa-minus text-xs"></i>
        </button>
        <span class="w-6 text-center">${item.quantity}</span>
        <button class="order-increase w-7 h-7 rounded-full border border-gray-300 flex items-center justify-center ml-2" data-id="${dish.id}">
          <i class="fa fa-plus text-xs"></i>
        </button>
        <span class="ml-4 font-medium">¥${itemTotal.toFixed(2)}</span>
      </div>
    `;
    container.appendChild(orderItem);
  });
  
  // 更新总价
  document.getElementById('subtotal').textContent = `¥${total.toFixed(2)}`;
  document.getElementById('total').textContent = `¥${total.toFixed(2)}`;
  
  // 绑定订单内的加减按钮事件
  document.querySelectorAll('.order-increase').forEach(btn => {
    btn.addEventListener('click', () => {
      const dishId = btn.getAttribute('data-id');
      const item = appState.cart.find(i => i.id === dishId);
      if (item) item.quantity += 1;
      else appState.cart.push({ id: dishId, quantity: 1 });
      localStorage.setItem('menuCart', JSON.stringify(appState.cart));
      updateCartCount();
      renderOrder();
    });
  });
  
  document.querySelectorAll('.order-decrease').forEach(btn => {
    btn.addEventListener('click', () => {
      const dishId = btn.getAttribute('data-id');
      const index = appState.cart.findIndex(i => i.id === dishId);
      if (index !== -1) {
        if (appState.cart[index].quantity > 1) {
          appState.cart[index].quantity -= 1;
        } else {
          appState.cart.splice(index, 1);
        }
        localStorage.setItem('menuCart', JSON.stringify(appState.cart));
        updateCartCount();
        renderOrder();
      }
    });
  });
};

// 10. 初始化所有事件监听
const initEvents = () => {
  // 导航按钮切换
  document.getElementById('menu-btn').addEventListener('click', () => showSection('menu-section'));
  document.getElementById('add-dish-btn').addEventListener('click', () => showSection('add-dish-section'));
  document.getElementById('order-btn').addEventListener('click', () => showSection('order-section'));
  
  // 移动端菜单
  document.getElementById('mobile-menu-btn').addEventListener('click', () => {
    document.getElementById('mobile-menu').classList.toggle('hidden');
  });
  document.getElementById('mobile-menu-btn-item').addEventListener('click', () => {
    showSection('menu-section');
    document.getElementById('mobile-menu').classList.add('hidden');
  });
  document.getElementById('mobile-add-dish-btn').addEventListener('click', () => {
    showSection('add-dish-section');
    document.getElementById('mobile-menu').classList.add('hidden');
  });
  document.getElementById('mobile-order-btn').addEventListener('click', () => {
    showSection('order-section');
    document.getElementById('mobile-menu').classList.add('hidden');
  });
  
  // 分类筛选
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const category = btn.getAttribute('data-category');
      appState.currentCategory = category;
      
      // 更新按钮样式
      document.querySelectorAll('.category-btn').forEach(b => {
        if (b.getAttribute('data-category') === category) {
          b.classList.add('bg-primary', 'text-white');
          b.classList.remove('bg-gray-200');
        } else {
          b.classList.remove('bg-primary', 'text-white');
          b.classList.add('bg-gray-200');
        }
      });
      
      renderDishes();
    });
  });
  
  // 搜索功能
  document.getElementById('search-input').addEventListener('input', (e) => {
    appState.searchTerm = e.target.value;
    renderDishes();
  });
  
  // 添加菜品表单
  document.getElementById('add-dish-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('dish-name').value.trim();
    const price = parseFloat(document.getElementById('dish-price').value);
    const category = document.getElementById('dish-category').value;
    const description = document.getElementById('dish-description').value.trim();
    const imageInput = document.getElementById('dish-image');
    
    // 验证必填项
    if (!name || !price || !category) {
      alert('请填写菜品名称、价格和分类（带*的为必填项）');
      return;
    }
    
    // 处理图片（默认图或上传图）
    let imageUrl = 'https://picsum.photos/seed/default/300/200';
    if (imageInput.files && imageInput.files[0]) {
      const reader = new FileReader();
      reader.onload = function(event) {
        imageUrl = event.target.result;
        saveNewDish(imageUrl);
      };
      reader.readAsDataURL(imageInput.files[0]); // 转成base64保存
    } else {
      saveNewDish(imageUrl);
    }
    
    // 保存新菜品到云端
    function saveNewDish(image) {
      const newDish = {
        id: 'd' + Date.now(), // 用时间戳生成唯一ID
        name,
        price,
        category,
        description,
        image
      };
      
      // 保存到云端
      dishesRef.child(newDish.id).set(newDish)
        .then(() => {
          // 重置表单并返回菜品列表
          document.getElementById('add-dish-form').reset();
          showSection('menu-section');
          loadDishes(); // 重新加载菜品列表
        })
        .catch(error => {
          console.error('保存菜品失败:', error);
          alert('添加菜品失败，请重试');
        });
    }
  });
  
  // 取消添加菜品
  document.getElementById('cancel-add-dish').addEventListener('click', () => {
    document.getElementById('add-dish-form').reset();
    showSection('menu-section');
  });
  
  // 订单相关按钮
  document.getElementById('go-to-menu-from-order').addEventListener('click', () => {
    showSection('menu-section');
  });
  
  document.getElementById('clear-order').addEventListener('click', () => {
    appState.cart = [];
    localStorage.setItem('menuCart', JSON.stringify(appState.cart));
    updateCartCount();
    renderOrder();
  });
  
  document.getElementById('confirm-order').addEventListener('click', () => {
    if (appState.cart.length === 0) return;
    
    // 显示成功弹窗
    const modal = document.getElementById('order-success-modal');
    const modalContent = document.getElementById('modal-content');
    modal.classList.remove('hidden');
    setTimeout(() => {
      modalContent.classList.remove('scale-95', 'opacity-0');
      modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
    
    // 清空购物车
    appState.cart = [];
    localStorage.setItem('menuCart', JSON.stringify(appState.cart));
    updateCartCount();
  });
  
  // 关闭弹窗
  document.getElementById('close-modal').addEventListener('click', () => {
    const modal = document.getElementById('order-success-modal');
    const modalContent = document.getElementById('modal-content');
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
      modal.classList.add('hidden');
      renderOrder(); // 刷新订单
    }, 300);
  });
};

// 11. 页面加载完成后初始化
window.addEventListener('DOMContentLoaded', () => {
  initEvents(); // 初始化事件
  updateCartCount(); // 更新购物车数量
  loadDishes(); // 加载菜品数据（原代码）
  
  // 添加以下代码：强制显示默认菜品（防止云端加载失败）
  setTimeout(() => {
    if (appState.dishes.length === 0) {
      appState.dishes = defaultDishes;
      renderDishes();
    }
  }, 3000); // 3秒后如果仍无数据，强制显示默认菜品
});
